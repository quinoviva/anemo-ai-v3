{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the Anemo Check application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user entity."
        },
        "firstName": {
          "type": "string",
          "description": "The first name of the user."
        },
        "lastName": {
          "type": "string",
          "description": "The last name of the user."
        },
        "email": {
          "type": "string",
          "description": "The email address of the user.",
          "format": "email"
        },
        "photoURL": {
          "type": "string",
          "description": "URL of the user's profile picture.",
          "format": "uri"
        },
        "address": {
          "type": "string",
          "description": "The user's full address for location-based services."
        },
        "medicalInfo": {
          "type": "object",
          "description": "User's medical information, including self-reported clinical data for AI-powered analysis.",
          "properties": {
            "dateOfBirth": {
              "type": "string",
              "format": "date-time",
              "description": "User's date of birth."
            },
            "sex": {
              "type": "string",
              "description": "User's biological sex. Used to tailor the diagnostic interview.",
              "enum": [
                "Male",
                "Female",
                "Other",
                "Prefer not to say"
              ]
            },
            "fatigue": {
              "type": "string",
              "description": "User's self-reported level of fatigue.",
              "enum": ["Mild", "Moderate", "Severe"]
            },
            "cardiovascularStrain": {
              "type": "string",
              "description": "User's self-reported level of cardiovascular strain.",
              "enum": ["None", "Noticeable", "High"]
            },
            "physicalIndicators": {
              "type": "string",
              "description": "User's self-reported physical indicators of anemia.",
              "enum": ["None", "Pale skin", "Brittle nails", "Swollen tongue"]
            },
            "height": {
              "type": "number",
              "description": "User's height in centimeters."
            },
            "weight": {
              "type": "number",
              "description": "User's weight in kilograms."
            },
            "bloodType": {
              "type": "string",
              "description": "User's blood type.",
              "enum": [
                "A+",
                "A-",
                "B+",
                "B-",
                "AB+",
                "AB-",
                "O+",
                "O-",
                "Unknown"
              ]
            },
            "allergies": {
              "type": "string",
              "description": "User's known allergies."
            },
            "conditions": {
              "type": "string",
              "description": "User's pre-existing medical conditions."
            },
            "medications": {
              "type": "string",
              "description": "List of current medications."
            },
            "familyHistory": {
              "type": "string",
              "description": "Relevant family medical history."
            }
          }
        }
      },
      "required": [
        "id",
        "firstName",
        "lastName",
        "email"
      ]
    },
    "LabReport": {
      "title": "Lab Report",
      "type": "object",
      "description": "Represents a scanned CBC lab report analysis.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the lab report."
        },
        "userId": {
          "type": "string",
          "description": "The ID of the user who owns this report."
        },
        "createdAt": {
          "type": "string",
          "format": "date-time",
          "description": "The timestamp when the report was created."
        },
        "hospitalName": {
          "type": "string",
          "description": "The name of the hospital or clinic where the CBC was performed."
        },
        "doctorName": {
          "type": "string",
          "description": "The name of the doctor who requested or reviewed the CBC report."
        },
        "summary": {
          "type": "string",
          "description": "AI-generated summary of the lab results."
        },
        "parameters": {
          "type": "array",
          "description": "Array of analyzed blood parameters.",
          "items": {
            "type": "object",
            "properties": {
              "parameter": {
                "type": "string"
              },
              "value": {
                "type": "string"
              },
              "unit": {
                "type": "string"
              },
              "range": {
                "type": "string"
              },
              "isNormal": {
                "type": "boolean"
              }
            },
            "required": ["parameter", "value", "unit", "isNormal"]
          }
        }
      },
      "required": ["id", "userId", "createdAt", "summary", "parameters"]
    },
    "ImageAnalysisReport": {
      "title": "Image Analysis Report",
      "type": "object",
      "description": "Represents a report generated from image analysis, a diagnostic interview, and includes a multimodal validation against clinical lab data.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the report."
        },
        "userId": {
          "type": "string",
          "description": "The ID of the user who owns this report."
        },
        "createdAt": {
          "type": "string",
          "format": "date-time",
          "description": "The timestamp when the report was created."
        },
        "riskScore": {
          "type": "number",
          "description": "The calculated anemia risk score (0-100)."
        },
        "recommendations": {
          "type": "string",
          "description": "AI-generated personalized health recommendations."
        },
        "imageAnalysisSummary": {
          "type": "string",
          "description": "A summary of the results from the image analysis step."
        },
        "reliabilityScore": {
            "type": "number",
            "description": "A score (0-100) indicating the reliability of the analysis based on cross-verification with clinical data."
        },
        "discrepancyAlert": {
            "type": "boolean",
            "description": "Flag indicating if a discrepancy was found between visual analysis and clinical data."
        }
      },
      "required": ["id", "userId", "createdAt", "riskScore", "recommendations", "imageAnalysisSummary"]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous",
      "google.com"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profile information, including self-reported clinical data. Accessible only by the user with matching UID.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user, matching the Firebase Auth UID."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/labReports/{reportId}",
        "definition": {
          "entityName": "LabReport",
          "schema": {
            "$ref": "#/backend/entities/LabReport"
          },
          "description": "Stores analyzed CBC lab reports for a user. Used as clinical data for multimodal validation.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user, matching the Firebase Auth UID."
            },
            {
              "name": "reportId",
              "description": "The unique identifier for the lab report."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/imageAnalyses/{analysisId}",
        "definition": {
          "entityName": "ImageAnalysisReport",
          "schema": {
            "$ref": "#/backend/entities/ImageAnalysisReport"
          },
          "description": "Stores AI-generated image analysis and questionnaire reports, including multimodal validation results.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user, matching the Firebase Auth UID."
            },
            {
              "name": "analysisId",
              "description": "The unique identifier for the image analysis report."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to ensure Authorization Independence, DBAC, and QAPs. User data is stored under `/users/{userId}` to establish clear ownership. The `userId` obtained from `request.auth.uid` is used to control access to user-specific data. This design avoids hierarchical authorization dependencies by storing authorization data directly within the user document, removing the need for `get()` calls in security rules.\n\nThe structure is segregated to ensure a homogeneous security posture. Each collection is designed to store a specific type of data with consistent access needs. For example, user profiles are stored in `/users/{userId}`, enabling straightforward rules based on user ID. Image analyses and lab reports are stored in sub-collections under the user's document to enforce ownership.\n\nThis design also facilitates QAPs by using path-based ownership for user data, enabling secure `list` operations within the sub-collections. The membership model is standardized with a `members` map for collaborative data, allowing easy management of roles and permissions.\n\nExplicit state modeling is achieved through dedicated `status` fields, and a predictable schema is maintained by avoiding dynamic keys and using arrays of objects with static keys. Naming conventions are standardized to ensure clarity and consistency throughout the database."
  }
}